drop dataverse test if exists;
create dataverse test;
use dataverse test;

create type Tweet as closed {
	id: int32,
	tweetid: int64,
	loc: point,
	time: datetime,
	text: string
}

create nodegroup group1 if not exists on nc1, nc2;

create dataset TwitterData(Tweet)
  partitioned by key id on group1;


load dataset TwitterData 
using "edu.uci.ics.asterix.external.dataset.adapter.NCFileSystemAdapter"
(("path"="nc1://data/twitter/extrasmalltweets.txt"),("format"="adm")) pre-sorted;

create index rtree_index_point on TwitterData(loc) type rtree;

write output to nc1:"rttest/spatial_cell-aggregation-with-filtering.adm";

for $t in dataset('TwitterData')
let $keyword := "Allergies"
let $region := polygon("
	33.80503407287759,-126.41235263538363 
	44.9090773200516,-126.41235263538363 
	44.9090773200516,-87.65258701038363 
	33.80503407287759,-87.65258701038363")

where spatial-intersect($t.loc, $region)  and
$t.time > datetime("2011-05-15T00:00:00Z") and $t.time < datetime("2011-05-16T23:59:59Z") and
contains($t.text, $keyword)
group by $c := spatial-cell($t.loc, create-point(24.5,-125.5), 3.0, 3.0) with $t
let $num :=  count($t)
order by $num
return { "cell": $c, "count": $num }
