drop dataverse twitter if exists;
create dataverse twitter;
use dataverse twitter;

create type Tweet as closed {
	id: int32,
	tweetid: int64,
	loc: point,
	time: datetime,
	text: string
}

create nodegroup group1 if exists on nc1, nc2;

create dataset TwitterData(Tweet)
  partitioned by key id on group1;


load dataset TwitterData 
using "edu.uci.ics.asterix.external.dataset.adapter.NCFileSystemAdapter"
(("path"="nc1://data/twitter/extrasmalltweets.txt"),("format"="adm")) pre-sorted;

create index rtree_index_point on TwitterData(loc) type rtree;

write output to nc1:"rttest/spatial_cell-aggregation-with-filtering.adm";

for $t in dataset('TwitterData')
let $region := polygon("
	33.80503407287759,-126.41235263538363 
	44.9090773200516,-126.41235263538363 
	44.9090773200516,-87.65258701038363 
	33.80503407287759,-87.65258701038363")

where spatial-intersect($t.loc, $region)
group by $c := spatial-cell($t.loc, create-point(24.5,-125.5), 3.0, 3.0) with $t
order by count($t)
return { "cell": $c, "count": count($t) }
